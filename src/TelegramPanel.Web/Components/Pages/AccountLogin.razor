@page "/accounts/login"
@inject IAccountService AccountService
@inject AccountManagementService AccountManagement
@inject IConfiguration Configuration
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@using TelegramPanel.Data.Entities

<PageTitle>手机号登录 - Telegram Panel</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">手机号登录</MudText>

<MudGrid>
    <MudItem xs="12" md="6" Class="mx-auto">
        <MudCard>
            <MudCardContent>
                <MudStepper @ref="stepper" Color="Color.Primary">
                    <MudStep Title="API 配置">
                        @if (!IsApiConfigured)
                        {
                            <MudAlert Severity="Severity.Warning" Class="mb-3">
                                <MudText Typo="Typo.body2">未配置全局 Telegram API（ApiId/ApiHash），无法登录。</MudText>
                            </MudAlert>
                            <MudButton Variant="Variant.Outlined" Color="Color.Primary" Href="/settings">
                                去系统设置配置
                            </MudButton>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info" Class="mb-3">
                                <MudText Typo="Typo.body2">使用全局 Telegram API：ApiId=@(Configuration["Telegram:ApiId"] ?? "（未配置）")</MudText>
                            </MudAlert>
                        }
                        <MudTextField @bind-Value="phoneNumber" Label="手机号" Variant="Variant.Outlined" Required="true"
                                      Placeholder="+86xxxxxxxxxx" Class="mt-3" />
                        <MudText Typo="Typo.caption" Class="mt-2" Color="Color.Info">
                            * 手机号需包含国家代码，例如：+8613800138000
                        </MudText>
                    </MudStep>

                    <MudStep Title="验证码" IsResultStep="false">
                        <MudText Typo="Typo.body1" Class="mb-3">
                            验证码已发送到 <strong>@phoneNumber</strong>
                        </MudText>
                        <MudTextField @bind-Value="verificationCode" Label="验证码" Variant="Variant.Outlined" Required="true"
                                      Placeholder="12345" />
                        <MudText Typo="Typo.caption" Class="mt-2" Color="Color.Info">
                            说明：验证码通常优先发送到已登录设备的 Telegram「系统通知（777000）」；没有可用设备时才可能发送短信/电话。
                        </MudText>
                        <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Class="mt-3"
                                   Disabled="@logging" OnClick="@(async (MouseEventArgs _) => await ResendCodeAsync())">
                            重新发送验证码（尝试切换通道）
                        </MudButton>
                    </MudStep>

                    <MudStep Title="密码验证" Optional="true">
                        <MudText Typo="Typo.body1" Class="mb-3">
                            此账号启用了两步验证，请输入密码
                        </MudText>
                        <MudTextField @bind-Value="password" Label="两步验证密码" Variant="Variant.Outlined"
                                      InputType="InputType.Password" Required="true" />
                    </MudStep>

                    <MudStep Title="完成" IsResultStep="true">
                        <MudAlert Severity="Severity.Success" Class="mb-3">
                            <MudText Typo="Typo.body1">登录成功并保存到数据库！</MudText>
                        </MudAlert>
                        <MudText Typo="Typo.body2"><strong>手机号：</strong>@phoneNumber</MudText>
                        <MudText Typo="Typo.body2"><strong>用户名：</strong>@(username ?? "无")</MudText>
                        <MudText Typo="Typo.body2"><strong>用户ID：</strong>@userId</MudText>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/accounts" Class="mt-4">
                            查看账号列表
                        </MudButton>
                    </MudStep>
                </MudStepper>
            </MudCardContent>
            <MudCardActions>
                <MudButton Variant="Variant.Text" Color="Color.Primary"
                           OnClick="@(async (MouseEventArgs _) => await ResetStepperAsync())">
                    重置
                </MudButton>
                <MudSpacer />
                @if ((stepper?.ActiveIndex ?? 0) > 0 && !IsFinished)
                {
                    <MudButton Variant="Variant.Text" Color="Color.Primary"
                               OnClick="@(async (MouseEventArgs _) => await PreviousStepAsync())">
                        上一步
                    </MudButton>
                }
                @if (!IsFinished)
                {
                    <MudButton Variant="Variant.Filled" Color="Color.Primary"
                               Disabled="@logging"
                               OnClick="@(async (MouseEventArgs _) => await NextStep())">
                        @if (logging)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>处理中...</span>
                        }
                        else
                        {
                            <span>@(IsLoginActionStep ? "登录" : "下一步")</span>
                        }
                    </MudButton>
                }
            </MudCardActions>
        </MudCard>
    </MudItem>
</MudGrid>

@code {
    private MudStepper? stepper;
    private bool logging = false;

    private int telegramApiId;
    private string telegramApiHash = "";
    private string sessionsPath = "sessions";
    private string phoneNumber = "";
    private string verificationCode = "";
    private string password = "";

    private string? username = "";
    private long userId = 0;
    private int accountId = 0;

    private bool TryGetTelegramApi(out int apiId, out string apiHash, out string configuredSessionsPath)
    {
        apiHash = Configuration["Telegram:ApiHash"] ?? "";
        configuredSessionsPath = Configuration["Telegram:SessionsPath"] ?? "sessions";
        return int.TryParse(Configuration["Telegram:ApiId"], out apiId)
               && apiId > 0
               && !string.IsNullOrWhiteSpace(apiHash);
    }

    private bool IsApiConfigured => TryGetTelegramApi(out _, out _, out _);

    private bool IsFinished =>
        stepper != null && stepper.ActiveIndex >= stepper.Steps.Count - 1;

    private bool IsLoginActionStep =>
        stepper != null && stepper.ActiveIndex == stepper.Steps.Count - 2;

    private async Task ResetStepperAsync()
    {
        if (stepper == null) return;
        await stepper.ResetAsync(true);
    }

    private async Task PreviousStepAsync()
    {
        if (stepper == null) return;
        await stepper.PreviousStepAsync();
    }

    private async Task NextStep()
    {
        if (stepper == null) return;

        var currentStep = stepper.ActiveIndex;
        logging = true;

        try
        {
            if (currentStep == 0)
            {
                // 步骤1：检查全局配置并发送验证码
                if (!TryGetTelegramApi(out telegramApiId, out telegramApiHash, out sessionsPath))
                {
                    Snackbar.Add("请先在【系统设置】中配置全局 Telegram API（ApiId/ApiHash）", Severity.Error);
                    return;
                }

                if (string.IsNullOrWhiteSpace(phoneNumber))
                {
                    Snackbar.Add("请填写完整信息", Severity.Error);
                    return;
                }

                // 生成临时账号ID（用于跟踪登录过程）
                accountId = Random.Shared.Next(1, int.MaxValue);

                var result = await AccountService.StartLoginAsync(accountId, phoneNumber);

                if (result.NextStep == "code")
                {
                    Snackbar.Add($"验证码已发送到 {phoneNumber}", Severity.Info);
                    await stepper.NextStepAsync();
                }
                else if (result.NextStep == "signup")
                {
                    Snackbar.Add("此号码未注册Telegram，请先注册", Severity.Error);
                }
                else
                {
                    Snackbar.Add(result.Message ?? "发送验证码失败", Severity.Error);
                }
            }
            else if (currentStep == 1)
            {
                // 步骤2：验证验证码
                if (string.IsNullOrWhiteSpace(verificationCode))
                {
                    Snackbar.Add("请输入验证码", Severity.Error);
                    return;
                }

                var result = await AccountService.SubmitCodeAsync(accountId, verificationCode);

                if (result.Success)
                {
                    // 登录成功，保存到数据库
                    await SaveAccount(result.Account!);
                }
                else if (result.NextStep == "password")
                {
                    Snackbar.Add("需要两步验证密码", Severity.Info);
                    await stepper.NextStepAsync();
                }
                else
                {
                    Snackbar.Add(result.Message ?? "验证码错误", Severity.Error);
                }
            }
            else if (currentStep == 2)
            {
                // 步骤3：验证密码
                if (string.IsNullOrWhiteSpace(password))
                {
                    Snackbar.Add("请输入密码", Severity.Error);
                    return;
                }

                var result = await AccountService.SubmitPasswordAsync(accountId, password);

                if (result.Success)
                {
                    await SaveAccount(result.Account!);
                }
                else
                {
                    Snackbar.Add(result.Message ?? "密码错误", Severity.Error);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"操作失败：{ex.Message}", Severity.Error);
        }
        finally
        {
            logging = false;
        }
    }

    private async Task ResendCodeAsync()
    {
        if (logging) return;
        if (accountId == 0)
        {
            Snackbar.Add("请先在上一步发送验证码", Severity.Warning);
            return;
        }

        logging = true;
        try
        {
            var result = await AccountService.ResendCodeAsync(accountId);
            Snackbar.Add(result.Message ?? "已请求重新发送验证码", result.Success ? Severity.Success : Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"重新发送失败：{ex.Message}", Severity.Error);
        }
        finally
        {
            logging = false;
        }
    }

    private async Task SaveAccount(TelegramPanel.Core.Models.AccountInfo accountInfo)
    {
        try
        {
            // 检查账号是否已存在
            var existingAccount = await AccountManagement.GetAccountByPhoneAsync(accountInfo.Phone!);

            if (existingAccount != null)
            {
                // 更新现有账号
                existingAccount.Username = accountInfo.Username;
                existingAccount.Nickname = BuildNickname(accountInfo);
                existingAccount.IsActive = true;
                existingAccount.ApiId = telegramApiId;
                existingAccount.ApiHash = telegramApiHash;
                existingAccount.LastSyncAt = DateTime.UtcNow;
                await AccountManagement.UpdateAccountAsync(existingAccount);

                Snackbar.Add("账号信息已更新", Severity.Success);
            }
            else
            {
                // 创建新账号
                var account = new Account
                {
                    Phone = accountInfo.Phone!,
                    UserId = accountInfo.TelegramUserId,
                    Nickname = BuildNickname(accountInfo),
                    Username = accountInfo.Username,
                    SessionPath = System.IO.Path.Combine(sessionsPath, $"{accountInfo.Phone}.session"),
                    ApiId = telegramApiId,
                    ApiHash = telegramApiHash,
                    IsActive = true,
                    CreatedAt = DateTime.UtcNow,
                    LastSyncAt = DateTime.UtcNow
                };

                await AccountManagement.CreateAccountAsync(account);
                Snackbar.Add("账号已保存到数据库", Severity.Success);
            }

            // 设置显示信息
            username = accountInfo.Username;
            userId = accountInfo.TelegramUserId;

            // 跳转到完成步骤
            if (stepper != null)
            {
                await stepper.NextStepAsync();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"保存账号失败：{ex.Message}", Severity.Error);
        }
    }

    private static string? BuildNickname(TelegramPanel.Core.Models.AccountInfo accountInfo)
    {
        var first = accountInfo.FirstName?.Trim();
        var last = accountInfo.LastName?.Trim();
        var display = string.Join(" ", new[] { first, last }.Where(s => !string.IsNullOrWhiteSpace(s)));
        if (!string.IsNullOrWhiteSpace(display))
            return display;

        return string.IsNullOrWhiteSpace(accountInfo.Username) ? null : accountInfo.Username.Trim();
    }
}
